# Lab 14. K8s

## Kube prometheus technology stack

### Prometheus operator
Helps in managing, deploying and configuring all the components in K8s.
### Prometheus
Collects all the metrics and send it to Alertmanager.
### Alertmanager
Manages all alerts from Prometheus and can trigger necessary entities with them.
### Prometheus node-exporter
For each node which it is installed on, it collects metrics and sends them to prometheus.
### Prometheus Adapter for Kubernetes Metrics APIs
It converts all K8s metrics to prometheus.
### kube-state-metrics
Listening the API server and sending generated metrics to K8s.
### Grafana
Displaying prometheus metrics in a pretty way with multiple dashboard.

## Terminal output

```
(devops) user@mbp-user k8s % kubectl get po,sts,svc,pvc,cm 
NAME                                                         READY   STATUS      RESTARTS      AGE
pod/prom-stack-grafana-9876b85869-hh9xr                      3/3     Running     0             21m24s
pod/prom-stack-kube-prometheus-operator-6sdbjx8547-lqjzw     1/1     Running     0             21m24s
pod/prom-stack-kube-state-metrics-8kjdsnfns-qz54l            1/1     Running     0             21m24s
pod/prom-stack-prometheus-node-exporter-k3scj                1/1     Running     0             21m24s
pod/prometheus-prom-stack-kube-prometheus-prometheus-0       2/2     Running     0             5m
pod/42.1.1-kube-prometheus-sta-admission-create-bkpsp        1/1     Running     0             31m43s
pod/alertmanager-prom-stack-kube-prometheus-alertmanager-0   2/2     Running     0             5m
pod/java-app-helm-0                                          1/1     Running     0             29m49s
pod/java-app-helm-1                                          1/1     Running     0             29m49s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-prom-stack-kube-prometheus-alertmanager   1/1     5m
statefulset.apps/prometheus-prom-stack-kube-prometheus-prometheus       1/1     5m
statefulset.apps/java-app-helm                                          2/2     28m27s

NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   5m
service/kubernetes                                ClusterIP      10.96.0.1        <none>        443/TCP                      15m
service/prom-stack-grafana                        ClusterIP      10.98.76.71      <none>        80/TCP                       22m24s
service/prom-stack-kube-prometheus-alertmanager   ClusterIP      10.107.212.34    <none>        9093/TCP                     22m24s
service/prom-stack-kube-prometheus-operator       ClusterIP      10.109.184.57    <none>        443/TCP                      22m24s
service/prom-stack-kube-prometheus-prometheus     ClusterIP      10.111.216.56    <none>        9090/TCP                     22m24s
service/prom-stack-kube-state-metrics             ClusterIP      10.110.127.83    <none>        8080/TCP                     22m24s
service/prom-stack-prometheus-node-exporter       ClusterIP      10.105.40.235    <none>        9100/TCP                     22m24s
service/prometheus-operated                       ClusterIP      None             <none>        9090/TCP                     5m
service/java-app-helm                             LoadBalancer   10.107.91.49     <pending>     80:31296/TCP                 28m27s

NAME                                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/persistent-volume-java-app-helm-0         Bound    pvc-93nvdlfm-e9ed-4d42-bbae-e5671d6580cb   64Mi       RWO            standard       8m27s
persistentvolumeclaim/persistent-volume-java-app-helm-1         Bound    pvc-dk9d32kv-e227-401e-bf79-321d8e30659e   64Mi       RWO            standard       8m27s

NAME                                                                     DATA   AGE
configmap/kube-root-ca.crt                                               1      15m
configmap/prom-stack-grafana                                             1      22m24s
configmap/prom-stack-grafana-config-dashboards                           1      22m24s
configmap/prom-stack-kube-prometheus-alertmanager-overview               1      22m24s
configmap/prom-stack-kube-prometheus-apiserver                           1      22m24s
configmap/prom-stack-kube-prometheus-cluster-total                       1      22m24s
configmap/prom-stack-kube-prometheus-controller-manager                  1      22m24s
configmap/prom-stack-kube-prometheus-etcd                                1      22m24s
configmap/prom-stack-kube-prometheus-grafana-datasource                  1      22m24s
configmap/prom-stack-kube-prometheus-grafana-overview                    1      22m24s
configmap/prom-stack-kube-prometheus-k8s-coredns                         1      22m24s
configmap/prom-stack-kube-prometheus-k8s-resources-cluster               1      22m24s
configmap/prom-stack-kube-prometheus-k8s-resources-namespace             1      22m24s
configmap/prom-stack-kube-prometheus-k8s-resources-node                  1      22m24s
configmap/prom-stack-kube-prometheus-k8s-resources-pod                   1      22m24s
configmap/prom-stack-kube-prometheus-k8s-resources-workload              1      22m24s
configmap/prom-stack-kube-prometheus-k8s-resources-workloads-namespace   1      22m24s
configmap/prom-stack-kube-prometheus-kubelet                             1      22m24s
configmap/prom-stack-kube-prometheus-namespace-by-pod                    1      22m24s
configmap/prom-stack-kube-prometheus-namespace-by-workload               1      22m24s
configmap/prom-stack-kube-prometheus-node-cluster-rsrc-use               1      22m24s
configmap/prom-stack-kube-prometheus-node-rsrc-use                       1      22m24s
configmap/prom-stack-kube-prometheus-nodes                               1      22m24s
configmap/prom-stack-kube-prometheus-nodes-darwin                        1      22m24s
configmap/prom-stack-kube-prometheus-persistentvolumesusage              1      22m24s
configmap/prom-stack-kube-prometheus-pod-total                           1      22m24s
configmap/prom-stack-kube-prometheus-prometheus                          1      22m24s
configmap/prom-stack-kube-prometheus-proxy                               1      22m24s
configmap/prom-stack-kube-prometheus-scheduler                           1      22m24s
configmap/prom-stack-kube-prometheus-workload-total                      1      22m24s
configmap/prometheus-prom-stack-kube-prometheus-prometheus-rulefiles-0   29     5m
configmap/java-app-helm-config                                           1      28m27s
```

## Lab questions
### 2
pod/java-app-helm-1 uses the biggest amount of memory
prometheus-operator - the least one
### 1&3 
Memory used 4.73 GiB  
Memory buffers 20.1 Mib  
Memory cached 913 Mib  
Memory free 113 Mib
### 4
1 Running Kubelets  
13 Running Pods
46 Running Containers
### 5
pod/java-app-helm-0 uses the biggest amount of network
node-exporter - the least one
### 6
8 alerts
0.085 ops/s

## Init container

SORA mainnet genesis block data downloaded

```
(devops) user@mbp-user k8s % kubectl exec pod/java-app-helm-0 -- cat ./block-data/sora_mainnet_genesis_block.json
Defaulted container "java-app-helm" out of: java-app-helm, download-file (init)
{"code":0,"message":"Success","generated_at":1874247352,"data":{"block_num":0,"block_timestamp":0,"hash":"0x79a1efa904809b683453a9af6856d38ad5e4e32d0feafd4f9c9414b0be86373f","parent_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","state_root":"0x61de7d887ab470b1f823dc60532d3ebe89d90ddb50d43655c7eef5ad0eb11c9c","extrinsics_root":"0x78786d8c082f29dcf4c11131403170a2e7597b7b7e3d84c05391d139a62b157e","extrinsics":null,"events":null,"logs":null,"event_count":0,"extrinsics_count":0,"spec_version":1,"validator":"","finalized":true,"account_display":null}}
```

## Bonus task

Additional Service Monitor will appear along previously created kubernetes components after:

```
(devops) user@mbp-user k8s % kubectl get smon | grep java
java-app-helm                                        89s
```

Queue result

```
(devops) user@mbp-user k8s % kubectl exec queue-pod -- cat /queue/file
Defaulted container "queue-container" out of: queue-container, init-1 (init), init-2 (init), init-3 (init)
queue1
queue2
queue3
```